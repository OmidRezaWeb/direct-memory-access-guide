# دسترسی مستقیم به حافظه (DMA)

## ۱. تعریف دقیق DMA و نقش آن در سیستم‌های کامپیوتری

دسترسی مستقیم به حافظه (Direct Memory Access یا DMA) قابلیتی است که به بخش‌های سخت‌افزاری سیستم (مانند کارت‌های صدا، گرافیک، شبکه و ...) اجازه می‌دهد بدون دخالت پردازنده مرکزی، مستقیماً داده‌ها را بین حافظه اصلی و خود جابجا کنند. در این حالت، CPU فقط در ابتدای عملیات انتقال نقش پیکربندی را بر عهده دارد و پس از آن می‌تواند به انجام سایر محاسبات بپردازد. پس از اتمام انتقال، کنترل‌کننده DMA با ارسال یک وقفه (Interrupt) به CPU اطلاع می‌دهد. استفاده از DMA باعث افزایش کارایی سیستم و کاهش بار پردازنده در هنگام انتقال داده‌های حجیم می‌شود. این ویژگی زمانی مفید است که پردازنده توان همگام‌سازی با سرعت انتقال داده را نداشته باشد یا نیاز به انجام کارهای دیگر در حین انتقال وجود داشته باشد.

## ۲. نحوه عملکرد کلی DMA و تفاوت آن با روش سنتی انتقال داده توسط CPU

در روش سنتی انتقال داده (Programmed I/O یا PIO)، پردازنده مرکزی باید تمامی عملیات خواندن و نوشتن داده را به‌صورت مستقیم انجام دهد و تا پایان انتقال درگیر بماند. اما در روش DMA، فرایند به دو مرحله تقسیم می‌شود:

- **انتقال داده با CPU (PIO):** در این روش، CPU برای هر بایت یا کلمه داده، دستورات مربوطه را اجرا کرده و داده‌ها را مستقیماً جابجا می‌کند. بنابراین، CPU در کل فرایند انتقال مشغول است و قادر به انجام کار دیگری نیست.
- **انتقال داده با DMA:** CPU فقط پارامترهای اولیه مانند آدرس مبدا، مقصد و تعداد داده‌ها را در رجیسترهای کنترل‌کننده DMA قرار می‌دهد. سپس DMA کنترل گذرگاه را در اختیار گرفته و داده‌ها را منتقل می‌کند. پس از پایان انتقال، با تولید یک وقفه، CPU را مطلع می‌سازد.

### مراحل پایه‌ای یک انتقال DMA:
1. دستگاه I/O یک درخواست (DMA Request) به کنترل‌کننده DMA ارسال می‌کند.  
2. DMA از CPU درخواست واگذاری کنترل گذرگاه می‌کند (Bus Request).  
3. پس از دریافت اجازه (Bus Grant)، CPU آدرس مبدا و طول داده‌ها را در رجیسترهای DMA می‌نویسد.  
4. DMA عملیات انتقال را به‌طور مستقل انجام می‌دهد.  
5. در پایان، وقفه‌ای برای CPU ارسال می‌شود.

## ۳. انواع حالت‌های DMA

کنترل‌کننده‌های DMA معمولاً از سه حالت انتقال پشتیبانی می‌کنند:

- **Burst Mode (حالت بلوکی یا انفجاری):** کل داده‌ها به صورت پیوسته منتقل می‌شوند. این روش سریع‌ترین نوع انتقال است اما در طول آن CPU به مدت طولانی بیکار می‌ماند.
- **Cycle Stealing Mode (حالت سرقت چرخه):** DMA پس از هر واحد انتقال، گذرگاه را به CPU بازمی‌گرداند. این حالت امکان اجرای متناوب دستورات توسط CPU را فراهم می‌کند.
- **Transparent Mode (حالت شفاف):** DMA فقط زمانی داده منتقل می‌کند که CPU از گذرگاه استفاده نمی‌کند. این روش بیشترین زمان انتقال را دارد اما کمترین تاثیر را روی CPU دارد و نیازمند سخت‌افزار پیچیده‌تری است.


![45e34bcf-8265-44ae-bb78-720fc2716c85](https://github.com/user-attachments/assets/523c88a1-5e4e-4188-b24c-727d48898a76)


## ۴. مثال‌های ساده و قابل درک

- **کارت صدا:** داده‌های صوتی از RAM مستقیماً به کارت صدا منتقل می‌شوند بدون دخالت CPU.  
- **کارت گرافیک:** کارت گرافیک با استفاده از DMA داده‌ها را از حافظه اصلی مستقیماً به VRAM منتقل می‌کند.  
- **هارد دیسک (Ultra DMA):** انتقال داده بین دیسک و RAM بدون دخالت مستقیم CPU انجام می‌شود.  
- **کارت شبکه:** بسته‌های شبکه از طریق DMA مستقیماً بین حافظه و کارت شبکه رد و بدل می‌شوند.

## ۵. دیاگرام‌های فنی از ساختار یا عملکرد DMA Controller

### ساختار کلی:

کنترل‌کننده DMA بین CPU، حافظه و دستگاه‌های I/O قرار گرفته و از طریق گذرگاه‌های آدرس، داده و کنترل با آن‌ها در ارتباط است. هنگام نیاز به انتقال، دستگاه I/O سیگنال Bus Request را ارسال کرده و پس از دریافت Bus Grant، کنترل‌کننده DMA داده‌ها را منتقل می‌کند.

### ساختار داخلی:

کنترل‌کننده DMA دارای اجزایی مانند:
- رجیستر آدرس (Address Register)  
- رجیستر شمارش کلمات (Word Count Register)  
- رجیستر کنترل (Control Register)  

CPU قبل از شروع انتقال، این رجیسترها را مقداردهی می‌کند. سپس DMA عملیات انتقال را با استفاده از آن‌ها انجام می‌دهد.

## ۶. جدول مقایسه‌ای بین انتقال داده با CPU و DMA

| ویژگی                | انتقال توسط CPU                         | انتقال توسط DMA                            |
|----------------------|-------------------------------------------|---------------------------------------------|
| سرعت انتقال          | پایین‌تر، وابسته به توان پردازنده        | بالاتر، بدون وابستگی به درگیری CPU        |
| بار پردازنده         | بسیار زیاد                                | بسیار کم                                    |
| پیچیدگی سخت‌افزاری   | کم                                        | زیاد (نیاز به کنترل‌کننده DMA و کانال‌ها) |
| مصرف گذرگاه سیستم    | کمتر (فقط CPU استفاده می‌کند)            | بیشتر (اشتراک گذرگاه با DMA)              |

استفاده از DMA باعث بهبود عملکرد کلی سیستم با کاهش بار پردازنده می‌شود، اما هزینه آن افزایش پیچیدگی سخت‌افزار است.

## ۷. کد نمونه برای راه‌اندازی DMA

```c
/* پیکربندی یک انتقال ساده DMA */
DMA_Channel0.SourceAddress = (uint32_t)sourceBuffer;     // آدرس مبدا
DMA_Channel0.DestAddress = (uint32_t)destBuffer;         // آدرس مقصد
DMA_Channel0.Count = dataLength;                         // تعداد واحدها
DMA_Channel0.Control = DMA_ENABLE | DMA_MEMORY_TO_MEMORY; // فعال‌سازی DMA و تنظیم جهت
DMA_Channel0.Start = 1;                                  // آغاز انتقال
```

در این مثال، با تنظیم رجیسترهای DMA، عملیات انتقال حافظه به حافظه فعال می‌شود. CPU پس از این مرحله آزاد است و تا پایان انتقال دخالتی ندارد.

